<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caltrain Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="/"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="/"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            margin-bottom: 20px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background-color: #007bff;
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0069d9;
            border-color: #0062cc;
        }
        .iframe-container {
            position: relative;
            overflow: hidden;
            padding-top: 56.25%; /* 16:9 aspect ratio */
        }
        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        #map-container {
            height: 500px;
            width: 100%;
            border-radius: 5px;
        }
        .train-icon {
            background-color: #007bff;
            border-radius: 50%;
            border: 2px solid white;
            text-align: center;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .northbound {
            background-color: #007bff;
        }
        .southbound {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1>Caltrain Performance Tracker</h1>
            <p class="lead">Real-time monitoring and analysis of Caltrain performance metrics</p>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h2>On-Time Performance by Date</h2>
                    </div>
                    <div class="card-body">
                        <div class="iframe-container">
                            <iframe src="/static/plots/daily_stats.html" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h2>Commute Period Analysis</h2>
                    </div>
                    <div class="card-body">
                        <div class="iframe-container">
                            <iframe src="/static/plots/commute_delay.html" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h2>Delay Minutes</h2>
                    </div>
                    <div class="card-body">
                        <div class="iframe-container">
                            <iframe src="/static/plots/delay_minutes.html" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h2>Real-Time Train Locations</h2>
                    </div>
                    <div class="card-body">
                        <div id="map-container"></div>
                        <div class="mt-3">
                            <div class="d-flex justify-content-center">
                                <div class="me-4">
                                    <span class="badge bg-primary">■</span> Northbound
                                </div>
                                <div>
                                    <span class="badge bg-danger">■</span> Southbound
                                </div>
                            </div>
                            <p class="text-center text-muted mt-2">Last updated: <span id="last-updated">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light text-center text-lg-start mt-4">
        <div class="container p-4">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <p>
                        Caltrain Tracker - Real-time monitoring and analysis of Caltrain performance
                        <br>
                        Data sourced from the 511.org GTFS-RT API
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize the map centered on Caltrain corridor
        const map = L.map('map-container').setView([37.4, -122.1], 10);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Store markers for trains
        let trainMarkers = {};
        
        // Store station markers
        const stationMarkers = {};
        
        // Function to load station data
        async function loadStations() {
            try {
                const response = await fetch('/api/stops');
                if (!response.ok) {
                    throw new Error('Failed to fetch station data');
                }
                
                const stations = await response.json();
                
                // Add station markers to the map
                stations.forEach(station => {
                    // Only add parent stations (not platforms)
                    if (!station.parent_station) {
                        const marker = L.circleMarker([station.stop_lat, station.stop_lon], {
                            radius: 5,
                            fillColor: '#333',
                            color: '#000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);
                        
                        marker.bindTooltip(station.stop_name);
                        stationMarkers[station.stop_id] = marker;
                    }
                });
            } catch (error) {
                console.error('Error loading station data:', error);
            }
        }
        
        // Function to create custom train icon
        function createTrainIcon(tripId, direction) {
            // Determine direction (northbound or southbound)
            const directionClass = direction === 'northbound' ? 'northbound' : 'southbound';
            
            return L.divIcon({
                className: `train-icon ${directionClass}`,
                html: `<div>${tripId.split('_')[0]}</div>`,
                iconSize: [24, 24]
            });
        }
        
        // Function to update train locations
        async function updateTrainLocations() {
            try {
                const response = await fetch('/api/train-locations?limit=50');
                if (!response.ok) {
                    throw new Error('Failed to fetch train locations');
                }
                
                const trainLocations = await response.json();
                
                // Group by trip_id and get the most recent location for each train
                const latestLocations = {};
                trainLocations.forEach(location => {
                    if (!latestLocations[location.trip_id] || 
                        new Date(location.timestamp) > new Date(latestLocations[location.trip_id].timestamp)) {
                        latestLocations[location.trip_id] = location;
                    }
                });
                
                // Update last updated time
                if (trainLocations.length > 0) {
                    const latestTimestamp = new Date(trainLocations[0].timestamp);
                    document.getElementById('last-updated').textContent = latestTimestamp.toLocaleString();
                }
                
                // Remove old markers
                const currentTripIds = Object.keys(latestLocations);
                Object.keys(trainMarkers).forEach(tripId => {
                    if (!currentTripIds.includes(tripId)) {
                        map.removeLayer(trainMarkers[tripId]);
                        delete trainMarkers[tripId];
                    }
                });
                
                // Add or update markers for current trains
                Object.values(latestLocations).forEach(train => {
                    // Determine direction based on trip_id (even numbers are typically southbound, odd are northbound)
                    // This is a simplification - in a real system you'd use the GTFS data to determine direction
                    const trainNumber = parseInt(train.trip_id.split('_')[0]);
                    const direction = trainNumber % 2 === 0 ? 'southbound' : 'northbound';
                    
                    if (trainMarkers[train.trip_id]) {
                        // Update existing marker
                        trainMarkers[train.trip_id].setLatLng([train.vehicle_lat, train.vehicle_lon]);
                    } else {
                        // Create new marker
                        const icon = createTrainIcon(train.trip_id, direction);
                        const marker = L.marker([train.vehicle_lat, train.vehicle_lon], { icon: icon }).addTo(map);
                        
                        // Add popup with train info
                        marker.bindPopup(`
                            <strong>Train:</strong> ${train.trip_id.split('_')[0]}<br>
                            <strong>Direction:</strong> ${direction.charAt(0).toUpperCase() + direction.slice(1)}<br>
                            <strong>Last Updated:</strong> ${new Date(train.timestamp).toLocaleString()}
                        `);
                        
                        trainMarkers[train.trip_id] = marker;
                    }
                });
                
            } catch (error) {
                console.error('Error updating train locations:', error);
                document.getElementById('last-updated').textContent = 'Error loading data';
            }
        }
        
        // Load stations when the page loads
        loadStations();
        
        // Update train locations immediately and then every 30 seconds
        updateTrainLocations();
        setInterval(updateTrainLocations, 30000);
    </script>
</body>
</html>
